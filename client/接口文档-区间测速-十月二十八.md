# API 文档：Interval Speed Evaluation 接口

## 接口地址：`/interval-speed`

### 请求方法：`POST`

### 描述：
此 API 用于评估轴长（AL）在一段时间内的增长速率，提供数据点、表示 AL 增长趋势的箭头，以及用于可视化的相关百分位信息。

### 请求体参数：
- **history_AL_records** (列表)：包含 AL 记录的列表，每个记录包含：
  - **time** (字符串, ISO 格式)：AL 记录的时间。
  - **AL** (浮点数)：轴长测量值。
- **birthday** (字符串, ISO 格式)：受试者的生日。
- **gender** (字符串)：受试者的性别，用于确定百分位。
- **is_normal** (布尔值)：指示受试者的 AL 数据是否应与正常数据集进行比较。

### 查询字符串参数：
- **id** (整数, 可选)：请求的可选标识符，通过查询参数提供。

### 响应：
- **id** (整数)：请求的标识符（如果提供）。
- **points** (列表)：包含 AL 数据点的列表，每个数据点包含：
  - **time** (字符串)：AL 测量的日期，格式为 `YYYY-MM-DD`。
  - **AL** (浮点数)：轴长测量值。
  - **AL_percentage** (浮点数)：给定 AL 值相对于参考数据的百分位。
- **arrows** (列表)：表示增长趋势的箭头列表，每个箭头包含：
  - **time_start** (字符串)：时间间隔的开始时间。
  - **time_end** (字符串)：时间间隔的结束时间。
  - **age_difference** (浮点数)：开始和结束时间之间的年龄差异（以年为单位）。
  - **AL_growth** (浮点数)：时间间隔内的 AL 增长（以毫米为单位）。
  - **AL_growth_yearly** (浮点数)：年度 AL 增长率。
  - **type_code** (整数)：表示增长趋势的代码：
    - `0`：无显著增长趋势。
    - `1`：AL 增长缓慢增加。
    - `2`：AL 增长快速增加。
- **y_axis_range** (对象)：包含以下字段的对象：
  - **min** (浮点数)：数据点中的最小 AL 百分位值。
  - **max** (浮点数)：数据点中的最大 AL 百分位值。
- **background** (对象)：用于可视化的数据矩阵，从背景参考数据中检索。

### 错误响应：
- **400 Bad Request**：当生日或时间格式无效时返回。
  ```json
  {
    "error": "Invalid birthday format"
  }
  ```
  ```json
  {
    "error": "Invalid time format"
  }
  ```
- **404 Not Found**：当参考数据文件 (`percentiles_gender{gender}_normal{is_normal}.csv`) 未找到时返回。
  ```json
  {
    "error": "The file percentiles_gender{gender}_normal{is_normal}.csv was not found."
  }
  ```
- **500 Internal Server Error**：当检索数据矩阵时出现问题返回。
  ```json
  {
    "error": "Error retrieving data matrix"
  }
  ```

### 示例请求：
```json
{
  "history_AL_records": [
    { "time": "2023-01-01T00:00:00", "AL": 23.5 },
    { "time": "2023-06-01T00:00:00", "AL": 23.8 }
  ],
  "birthday": "2015-05-20",
  "gender": "male",
  "is_normal": true
}
```

### 示例响应：
```json
{
  "id": 1,
  "points": [
    {
      "time": "2023-01-01",
      "AL": 23.5,
      "AL_percentage": 45
    },
    {
      "time": "2023-06-01",
      "AL": 23.8,
      "AL_percentage": 50
    }
  ],
  "arrows": [
    {
      "time_start": "2023-01-01",
      "time_end": "2023-06-01",
      "age_difference": 0.5,
      "AL_growth": 0.3,
      "AL_growth_yearly": 0.6,
      "type_code": 2
    }
  ],
  "y_axis_range": {
    "min": 45,
    "max": 50
  },
  "background": {
    "data": [/* background data matrix here */]
  }
}
```

### id 的正确用法：
在查询字符串中提供 `id` 参数可以为请求添加唯一标识符，便于在后续处理中引用该请求。例如：

```
/interval-speed?id=1
```

在响应中，将返回相同的 `id` 值，以便客户端能够将响应与原始请求关联起来。

### 使用带有 id 的请求示例：
以下是带有 `id` 的请求示例，使用 `curl` 工具：

```bash
curl -X POST "https://vpac-chart.cqwangkuai.com/interval-speed?id=1" \
-H "Content-Type: application/json" \
-d '{
  "history_AL_records": [
    {
      "time": "2023-01-01",
      "AL": 22.5
    },
    {
      "time": "2023-06-01",
      "AL": 23.0
    },
    {
      "time": "2023-12-01",
      "AL": 23.0
    },
    {
      "time": "2024-06-01",
      "AL": 23.2
    }
  ],
  "birthday": "2015-01-01",
  "gender": 1,
  "is_normal": false
}'
```

在上述请求中，查询字符串参数 `id=1` 被包含在请求 URL 中，以便在响应中返回相应的 `id`。
